# Elasticsearch Essential

> [ElasticSearch Essential](https://www.inflearn.com/course/elasticsearch-essential) 강의 및 [공식 문서](https://www.elastic.co/guide/en/elasticsearch/reference/8.10/index.html) 참고

## Overview

### What is Elasticsearch?

- [Apache Lucene](https://lucene.apache.org/) 기반의 [오픈소스](https://github.com/elastic/elasticsearch) **분산 검색&분석 엔진**
- JSON 기반의 문서를 저장(색인), 검색, 분석
- 주요 특징
    - **준실시간** 검색 시스템 : 데이터가 저장되고 나서 거의 바로 검색이 가능
        - 데이터가 저장되는 시점과 검색 가능한 시점의 간격(`refresh_interval` 설정값으로 조정 가능)이 거의 실시간 수준으로 짧음
        - `refresh_interval` 설정의 기본값은 1초
        - [Near real-time search | Elasticsearch Guide [8.10]](https://www.elastic.co/guide/en/elasticsearch/reference/8.10/near-real-time.html#img-pre-refresh)
    - 고가용성을 위한 **클러스터(한 대 이상의 노드) 구성** : 안정성 증가, 부하 분산
    - **동적 스키마** 지원
        - 미리 스키마를 정의하지 않아도 됨 (<-> RDBMS의 경우 테이블 스키마를 정의해야 데이터 입력 가능)
        - 스키마 개념이 없다는게 아니라, ES가 문서 색인을 하면서 스키마를 자동으로 생성해내는 방식
    - **REST API 기반 인터페이스** 제공

### Elasticsearch 클러스터와 노드

- 클러스터 : **여러 대의 ES 노드가 모여 하나의 시스템처럼 동작**
- 노드
    - 노드의 종류 : **각자 다른 역할을 가진 노드**들이 모여 클러스터를 이룸
        - **마스터 노드**
            - 클러스터 상태 관리, 메타데이터 관리
            - 클러스터 내 하나의 마스터 노드가 있고, 마스터가 죽으면 마스터 후보 노드들 중에 하나가 새 마스터가 됨
        - **데이터 노드** : 문서 색인, 검색 요청 처리
        - **코디네이팅 노드** : 검색 요청 처리
        - **인제스트 노드** : 색인되는 문서의 데이터 전처리
- 노드마다 역할이 다르기에, **각 노드가 본인의 역할에 충실할 수 있도록 클러스터를 구성하는 것이 중요**
    - 사실 노드는 자기가 처리할 수 없는 요청을 받아도 알맞은 노드에게 전달해 처리하기 때문에, 어느 노드에 요청하든 얻는 결과는 같음
    - 하지만 노드 입장에선 처리할 수 없는 요청을 받고, 다른 노드에 넘겨 처리하는 이런 과정 자체가 불필요하고 비효율적

### Elasticsearch 인덱스와 샤드

- 인덱스 : **문서가 저장되는 논리적인 공간** (!= RDBMS의 인덱스) (~= RDBMS의 database)
    - 문서를 저장하기 위해선 반드시 인덱스가 필요
    - ES를 도입하기 위한 첫 단계는 **인덱스의 설계** (= 문서들을 어떤 인덱스에 어떻게 저장할 것이냐)
        - 인덱스 설계에 따라 문서 구조, 검색 쿼리도 달라지기 때문에
            - e.g. 도서관의 도서 정보를 보관할 때
                - 설계 A : `library`라는 하나의 인덱스를 사용
                    - 문서 구조 : 책의 종류를 문서에 저장
                    - 검색 쿼리 : 책의 종류를 통해 쿼리 요청
                - 설계 B : 책의 종류별로 여러 개의 인덱스를 사용
                    - 문서 구조 : 책의 종류를 저장할 필요 없음
                    - 검색 쿼리 : 책의 종류를 포함해 쿼리를 작성할 필요 없고, 각 인덱스에 쿼리 요청
        - 커다란 하나의 인덱스를 사용할 것이냐, 혹은 여러 인덱스로 나누어 사용할 것이냐
            - 하나의 인덱스 사용할 경우
                - 인덱스가 하나뿐이니 관리 리소스가 적어 좋음
                - 쿼리와 문서의 구조가 복잡해질 수 있음
            - 여러 인덱스로 나누어 사용할 경우
                - 쿼리와 문서 구조를 최적화하여 사용할 수 있음
                - 인덱스가 여러 개라 관리 리소스가 많이 소요
            - 초기 규모에서는 하나의 인덱스로 사용하다가, 필요에 따라 확장하여 별도의 여러 인덱스를 운영하는 방법도 있음
- 샤드 : 인덱스에 색인되는 문서가 저장되는 공간
    - 하나의 인덱스에는 반드시 하나 이상의 샤드가 필요
    - 샤드의 종류
        - **프라이머리 샤드**
            - 문서가 저장되는 원본 샤드
            - 색인과 검색 성능 모두에 영향을 줌
        - **레플리카 샤드**
            - 프라이머리 -> 레플리카로 문서가 복제됨
            - 주로 검색 성능에 영향을 줌
            - 프라이머리에 문제가 생기면 레플리카가 프라이머리로 승격
        - 색인 성능은 프라이머리 샤드의 영향이 큼
            - 색인 과정 상 문서는 프라이머리 샤드에서 분석된 후 저장되고, 이것이 레플리카 샤드로 복제됨
            - 분석 과정에서 가장 많은 CPU & 메모리 리소스를 사용하는데, 이걸 프라이머리에서 수행하기 때문에 색인 성능은 프라이머리 샤드 영향이 큼
            - 레플리카 샤드의 영향이 없다고 할 수는 없음
    - 샤드 개수 설정
        - `number_of_shards` : 프라이머리 샤드의 개수
            - 한번 설정하면 바꿀 수 없음 (후술하겠지만 이유는 샤드 라우팅 룰이 모듈러 방식이기 때문)
                - Q. 그럼에도 불구하고 조정이 필요하다면? 문서들을 각 샤드에 재할당한다거나 하는 방법이 없을까?
                    - 이미 만들어진 인덱스에서 조정하는 방법은 안보이고, 새 인덱스를 만든 후 [Reindex API](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html)로 문서들을 복사하는 방법 정도가 있는 듯
            - 버전 7 이후 기본값은 1인데, 이를 그대로 사용하면 성능에 큰 영향을 미칠 수 있음
        - `number_of_replicas` : 프라이머리 하나당 레플리카 샤드의 개수
            - 프라이머리 샤드 개수와는 달리, 레플리카 샤드 개수는 언제든 자유롭게 변경이 가능함
    - 샤드 라우팅
        - (프라이머리) 샤드가 3개라서 0, 1, 2번 샤드에 문서가 나누어 저장되어 있다면...
            - 문서를 저장해야 하는데, 어느 샤드에 저장해야 하지?
            - 문서를 찾고 싶은데, 어느 샤드에 문서가 저장되어 있지?
        - 라우팅 룰은 모듈러 : 문서의 ID % `number_of_shards`
            - 만약 샤드 개수가 바뀌면 라우팅 룰이 맞지 않음 -> 그래서 `number_of_shards`는 한번 설정하면 바꿀 수 없음
- 인덱스 템플릿
    - 인덱스를 만드는 수고를 덜기 위한 기능으로서, 인덱스의 설정(e.g. 샤드 개수)을 템플릿으로 미리 만들어둘 수 있음
    - 템플릿에 문자열 패턴을 미리 지정해두고, 해당 패턴과 매칭되는 이름의 인덱스가 생기면 템플릿이 적용되는 식
    - e.g. 이름이 `nginx-logs-`로 시작하는 이름의 인덱스는 `number_of_shards` 3을 사용하고...

### 매핑

- 문서의 구조를 나타내는 정보 (~= RDBMS의 스키마)
- 매핑의 종류
    - 동적 매핑 : 처음 색인되는 문서를 바탕으로 ES가 매핑 정보를 자동으로 생성하는 방식
    - 정적 매핑 : 사용자가 색인될 문서의 매핑 정보를 미리 정의하는 방식
        - [Update mapping API | Elasticsearch Guide [8.10]](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html) (앞으로 API 문서를 잘 참고해보자)
        - 동적 매핑 쓰면 자동으로 해주는데 **정적 매핑 왜 씀?**
            - 필드들이 가지는 값에 따라 타입을 직접 지정해줄 필요가 있을 때 (e.g. 값의 범위가 너무 넓어서 `float`이 아니라 `double` 타입을 써야 해!)
            - 불필요한 색인이 발생하지 않게 하기 위해 (e.g. 문자열 필드마다 자동 생성되는 `keyword` 타입)
- 동적이든 정적이든 매핑 정보가 만들어진 후에는 저장할 문서의 타입이 맞지 않으면 파싱 에러가 발생
- 매핑 정보 조회하기 : [Get mapping API | Elasticsearch Guide [8.10]](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-mapping.html)

## 어떻게 동작하는가

...

## 모니터링

...